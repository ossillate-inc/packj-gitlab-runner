stages:
  - audit
  - deploy

variables:
  DEPENDENCY_FILES: pypi:requirements.txt

packj-audit-job:
  stage: audit
  image: docker:20.10.16
  services:
    - docker:dind # necessary for docker run

  script:
    - |
      input=$(echo "$DEPENDENCY_FILES" | sed 's/,/ /g')
      input_files=()

      for item in $input; do
        if [[ $item == *":"* ]]; then
                pm_name=$(echo $item | cut -f1 -d:)  
                dep_file=$(echo $item | cut -f2 -d:)    
                input_files+=$pm_name":/tmp/packj/"$dep_file" "
        fi
      done

      echo "$input_files" > input_files.txt

    - docker run --name packj-container -v /tmp:/tmp/packj -t ossillate/packj:latest
    - docker cp ./requirements.txt packj-container:/tmp/packj/requirements.txt
    - docker run -v /tmp:/tmp/packj -t ossillate/packj:latest audit -f $(cat input_files.txt)

comment-job:
  stage: deploy
  environment: production
  script:
    - echo "Adding comment to PR..."
